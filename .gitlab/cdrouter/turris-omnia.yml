.turris-cdrouter: &turris_cdrouter
  allow_failure: true
  needs: ["build test mvebu prpl security"]
  extends:
    - .turris-omnia testbed
    - .cdrouter
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: manual

CDRouter-Top-100+mDNS Turris initramfs:
  <<: *turris_cdrouter
  variables:
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-dyndns.sh

CDRouter-Top-100+mDNS Turris VLAN WAN/LAN initramfs:
  <<: *turris_cdrouter
  variables:
    CDROUTER_TEST_CONFIG: vlan
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-dyndns.sh
      .gitlab/scripts/dut-init/cdrouter-dut-enable-vlans.sh

CDRouter-Top-100+mDNS Turris PPPoE WAN initramfs:
  <<: *turris_cdrouter
  variables:
    CDROUTER_TEST_CONFIG: ppp
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-dyndns.sh
      .gitlab/scripts/dut-init/cdrouter-dut-enable-pppoe.sh

CDRouter-Wireless Turris initramfs:
  <<: *turris_cdrouter
  stage: smoke tests
  timeout: 15 minutes
  variables:
    CDROUTER_TEST_CONFIG: wireless
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-wireless.sh


.turris-cdrouter-ipv6: &turris_cdrouter_ipv6
  <<: *turris_cdrouter
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: manual

CDRouter-UPnP-IPv46 Turris initramfs:
  <<: *turris_cdrouter_ipv6
  timeout: 60 minutes
  variables:
    CDROUTER_TEST_CONFIG: generic-ipv6-upnp
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh

CDRouter-UPnP-IPv46-Failing Turris initramfs:
  <<: *turris_cdrouter_ipv6
  timeout: 120 minutes
  allow_failure: true
  variables:
    CDROUTER_TEST_CONFIG: generic-ipv6-upnp
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh

CDRouter-IPv6-Top-100+mDNS Turris initramfs:
  <<: *turris_cdrouter_ipv6
  variables:
    CDROUTER_TEST_CONFIG: generic-ipv6
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh

prpl-Certification Turris initramfs:
  <<: *turris_cdrouter_ipv6
  timeout: 120 minutes
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: manual
  variables:
    CDROUTER_TEST_CONFIG: generic-ipv6
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-cwmpd.sh

CDRouter-IPv6-Top-100+mDNS Turris VLAN WAN/LAN initramfs:
  <<: *turris_cdrouter_ipv6
  variables:
    CDROUTER_TEST_CONFIG: vlan-ipv6
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-enable-vlans.sh

.CDRouter-IPv6-Top-100+mDNS Turris PPPoE WAN initramfs:
  <<: *turris_cdrouter_ipv6
  variables:
    CDROUTER_TEST_CONFIG: ppp-ipv6
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-enable-pppoe.sh

CDRouter-TR-069 Turris eMMC:
  <<: *turris_cdrouter
  variables:
    LABGRID_TARGET: turris-omnia-emmc
    TFTP_IMAGE_FILENAME: prplos-mvebu-cortexa9-cznic_turris-omnia-sysupgrade.img.gz
    TFTP_IMAGE_FILENAME_PATTERN: /.*prplos-mvebu-cortexa9-cznic_turris-omnia-sysupgrade.img.gz/
    TFTP_IMAGE_UNPACK_COMMAND: "gunzip --force $TESTBED_TFTP_PATH/$TFTP_IMAGE_FILENAME || true"
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-tr181-mockups.sh

CDRouter-USP-prpl Turris initramfs:
  <<: *turris_cdrouter
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: manual
  variables:
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-dyndns.sh

prplWare-Smoke-Test-Suite Turris initramfs:
  <<: *turris_cdrouter_ipv6
  stage: smoke tests
  variables:
    CDROUTER_TEST_CONFIG: smoke-test
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-tr181-mockups.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-dyndns.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-prplmesh-controller.sh

.turris-certification: &turris_certification
  <<: *turris_cdrouter_ipv6
  stage: certification tests
  timeout: 1h 45m
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: manual
  variables:
    CDROUTER_TEST_CONFIG: prplos-certification
    DUT_INIT_SCRIPTS: |
      .gitlab/scripts/dut-init/cdrouter-dut-flush-dns-relay-cache.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-cwmpd.sh
      .gitlab/scripts/dut-init/cdrouter-dut-configure-prplos-certification.sh

prplOS-Network-Test-Plan-Mandatory-v1.2.0 Turris initramfs:
  <<: *turris_certification

prplOS-Network-Test-Plan-Candidate-v1.2.0 Turris initramfs:
  <<: *turris_certification
  timeout: 52 minutes
